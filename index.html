<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Karang Taruna Kuti Berseri</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      background: #f5f7fa;
      font-family: 'Segoe UI', sans-serif;
    }
    .header {
      background: #28a745;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .card-box {
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform .2s;
    }
    .card-box:hover { transform: scale(1.02); }
    table th, table td {
      vertical-align: middle;
      text-align: center;
    }
    .swal2-popup {
      font-size: 0.9rem !important;
      border-radius: 12px !important;
    }
    .toolbar-small .btn{
      white-space: nowrap;
    }
    @media (max-width: 576px) {
      .header h4 { font-size: 1rem; }
      .header small { font-size: 0.75rem; }
      .header span { font-size: 0.85rem; }
      .card-box { padding: 10px; }
      table { font-size: 0.8rem; }
      table th, table td { padding: 6px; }
      .btn { font-size: 0.75rem; padding: 4px 8px; }
      .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    }
    .badge-kategori { font-size: 0.7rem; }
  </style>
</head>
<body class="container py-4">

  <div class="header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div>
      <h4 class="mb-0">üë• Karang Taruna Kuti Berseri</h4>
      <small>Sistem Catatan Iuran Bulanan</small><br>
      <small id="loginInfo" class="opacity-75">Tidak login</small>
    </div>
    <div class="d-flex gap-2 align-items-center flex-wrap">
      <select id="tahunSelect" class="form-select form-select-sm"></select>
      <select id="bulanSelect" class="form-select form-select-sm"></select>
      <select id="kategoriFilter" class="form-select form-select-sm">
        <option value="">Semua Kategori</option>
        <option value="Iuran">Iuran</option>
        <option value="Kegiatan">Kegiatan</option>
        <option value="Perlengkapan">Perlengkapan</option>
        <option value="Donasi">Donasi</option>
        <option value="Lainnya">Lainnya</option>
      </select>
      <span class="fw-bold">Saldo: <span id="saldo">Rp 0</span></span>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-6 col-md-3 mb-2">
      <div class="card card-box text-center p-3 border-primary">
        <h6>Total Pemasukan</h6>
        <h5 class="text-primary" id="totalPemasukan">Rp 0</h5>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-2">
      <div class="card card-box text-center p-3 border-danger">
        <h6>Total Pengeluaran</h6>
        <h5 class="text-danger" id="totalPengeluaran">Rp 0</h5>
      </div>
    </div>
    <div class="col-12 col-md-6 mb-2">
      <div class="card card-box p-3">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-2">Ringkasan</h6>
          <small id="persentaseBayar" class="text-muted"></small>
        </div>
        <div class="text-muted">Gunakan tombol di toolbar untuk ekspor, reminder, dan manajemen data.</div>
      </div>
    </div>
  </div>

  <div class="mb-3 d-flex flex-wrap gap-2 toolbar-small">
    <button class="btn btn-primary" onclick="tambahAnggota()">‚ûï Tambah Anggota</button>
    <button class="btn btn-success" onclick="tambahIuran()">üí∞ Tambah Iuran</button>
    <button class="btn btn-danger" onclick="tambahPengeluaran()">üßæ Tambah Pengeluaran</button>
    <button class="btn btn-secondary" onclick="unduhPDF()">üìÑ Unduh PDF (Bulan)</button>
    <button class="btn btn-outline-secondary" onclick="exportTransaksiExcel()">‚¨áÔ∏è Export Excel (Bulan)</button>
    <button class="btn btn-outline-secondary" onclick="exportTahunanExcel()">‚¨áÔ∏è Export Excel (Tahunan)</button>
    <button class="btn btn-outline-primary" onclick="exportAnggotaExcel()">‚¨áÔ∏è Export Anggota (Excel)</button>
    <button class="btn btn-outline-primary" onclick="exportAnggotaPDF()">üìÑ Anggota (PDF)</button>
    <button class="btn btn-warning" onclick="ingatkanBelumBayar()">üîî Reminder Belum Bayar</button>
    <button class="btn btn-outline-dark" onclick="login()">üîê Login</button>
    <button class="btn btn-outline-success" onclick="kirimNotifikasiAdmin('Notifikasi dari sistem Karang Taruna: ada update data iuran/transaksi.')">üì£ Notif Admin</button>
  </div>

  <!-- Daftar Anggota -->
  <div class="card card-box mb-3">
    <div class="card-header fw-bold">Daftar Anggota</div>
    <div class="card-body p-0 table-responsive">
      <table class="table table-striped mb-0">
        <thead class="table-light">
          <tr>
            <th>No</th>
            <th>Nama</th>
            <th>Iuran Bulan Ini</th>
            <th>Status</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="anggotaList">
          <tr><td colspan="5">Belum ada data anggota</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Riwayat Transaksi -->
  <div class="card card-box">
    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
      <span>Riwayat Transaksi</span>
      <small class="text-muted" id="infoFilterKategori">Filter: Semua</small>
    </div>
    <div class="card-body p-0 table-responsive">
      <table class="table table-striped mb-0">
        <thead class="table-light">
          <tr>
            <th>Tanggal</th>
            <th>Keterangan</th>
            <th>Jenis</th>
            <th>Nominal</th>
            <th>Kategori</th>
            <th>Bukti</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="transaksiList">
          <tr><td colspan="7">Belum ada transaksi</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;
    let anggota = JSON.parse(localStorage.getItem("anggota")) || []; // {nama, alamat, hp, jabatan, aktif:true}
    let transaksi = JSON.parse(localStorage.getItem("transaksi")) || []; // {tanggal,keterangan,jenis,nominal,bulan,tahun,kategori,buktiDataUrl, nama?}
    let config = JSON.parse(localStorage.getItem("config")) || {
      defaultIuran: 10000,
      adminNumbers: ["6285755030397","6281217726383"],
      roles: {
        Ketua: "1111",
        Bendahara: "2222"
      },
      currentUser: null // {role}
    };

    function simpanData() {
      localStorage.setItem("anggota", JSON.stringify(anggota));
      localStorage.setItem("transaksi", JSON.stringify(transaksi));
      localStorage.setItem("config", JSON.stringify(config));
    }

    function formatRupiah(angka) {
      if (isNaN(angka)) return "Rp 0";
      return "Rp " + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function isiDropdown() {
      let tahunSelect = document.getElementById("tahunSelect");
      let bulanSelect = document.getElementById("bulanSelect");
      let kategoriFilter = document.getElementById("kategoriFilter");
      let now = new Date();
      let tahunSekarang = now.getFullYear();
      let bulanSekarang = now.getMonth() + 1;

      tahunSelect.innerHTML = "";
      for (let t = 2023; t <= tahunSekarang; t++) {
        let opt = document.createElement("option");
        opt.value = t; opt.text = t;
        if (t === tahunSekarang) opt.selected = true;
        tahunSelect.appendChild(opt);
      }

      const bulanNama = ["Januari","Februari","Maret","April","Mei","Juni","Juli",
                         "Agustus","September","Oktober","November","Desember"];
      bulanSelect.innerHTML = "";
      for (let b=1; b<=12; b++) {
        let opt = document.createElement("option");
        opt.value = b; opt.text = bulanNama[b-1];
        if (b === bulanSekarang) opt.selected = true;
        bulanSelect.appendChild(opt);
      }

      tahunSelect.onchange = render;
      bulanSelect.onchange = render;
      kategoriFilter.onchange = render;
    }

    function bulanDanTahunSekarang() {
      let now = new Date();
      return {bulan: now.getMonth()+1, tahun: now.getFullYear()};
    }

    function cekBulanAktif() {
      let {bulan, tahun} = bulanDanTahunSekarang();
      let tahunDipilih = parseInt(document.getElementById("tahunSelect").value);
      let bulanDipilih = parseInt(document.getElementById("bulanSelect").value);
      return bulan===bulanDipilih && tahun===tahunDipilih;
    }

    function persenSudahBayar(bulanDipilih, tahunDipilih){
      if (anggota.length === 0) return 0;
      let sudah = 0;
      anggota.forEach(a=>{
        let iuranBulan = transaksi.filter(t=>t.jenis==="Pemasukan" && t.nama==a.nama && t.bulan==bulanDipilih && t.tahun==tahunDipilih)
                          .reduce((sum,t)=>sum+t.nominal,0);
        if (iuranBulan>0) sudah++;
      });
      return Math.round(sudah/anggota.length*100);
    }

    function render() {
      let tahunDipilih = parseInt(document.getElementById("tahunSelect").value);
      let bulanDipilih = parseInt(document.getElementById("bulanSelect").value);
      let kategoriDipilih = document.getElementById("kategoriFilter").value;

      // Render anggota
      let anggotaList = document.getElementById("anggotaList");
      if (anggota.length === 0) {
        anggotaList.innerHTML = '<tr><td colspan="5">Belum ada data anggota</td></tr>';
      } else {
        anggotaList.innerHTML = "";
        anggota.forEach((a,i)=>{
          let iuranBulan = transaksi.filter(t=>t.jenis==="Pemasukan" && t.nama==a.nama && t.bulan==bulanDipilih && t.tahun==tahunDipilih)
                            .reduce((sum,t)=>sum+t.nominal,0);
          let status = (a.aktif===false) ? '<span class="badge text-bg-secondary">Nonaktif</span>' :
                       (iuranBulan>0 ? '<span class="badge text-bg-success">Sudah</span>' : '<span class="badge text-bg-warning">Belum</span>');
          anggotaList.innerHTML += `
            <tr>
              <td>${i+1}</td>
              <td>
                <div class="fw-semibold">${a.nama}</div>
                <div class="text-muted" style="font-size:.8rem">${a.jabatan||'-'} ‚Ä¢ ${a.hp||'-'}</div>
              </td>
              <td>${formatRupiah(iuranBulan)}</td>
              <td>${status}</td>
              <td class="d-flex gap-1 justify-content-center flex-wrap">
                <button class="btn btn-sm btn-warning" onclick="editAnggota(${i})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="hapusAnggota(${i})">Hapus</button>
                <button class="btn btn-sm btn-success" onclick="tandaiLunas(${i})">Lunas</button>
                <button class="btn btn-sm btn-outline-success" onclick="kirimWAIndividu(${i})">WA</button>
              </td>
            </tr>`;
        });
      }

      // Filter transaksi (bulan, tahun, dan kategori jika diisi)
      let transaksiList = document.getElementById("transaksiList");
      let filtered = transaksi.filter(t=>t.bulan==bulanDipilih && t.tahun==tahunDipilih)
      if (kategoriDipilih) filtered = filtered.filter(t => (t.kategori||"") === kategoriDipilih || (kategoriDipilih==="Iuran" && t.kategori==="Iuran"));
      document.getElementById("infoFilterKategori").innerText = "Filter: " + (kategoriDipilih || "Semua");

      if (filtered.length === 0) {
        transaksiList.innerHTML = '<tr><td colspan="7">Belum ada transaksi</td></tr>';
      } else {
        transaksiList.innerHTML = "";
        filtered.forEach((t)=>{
          const idx = transaksi.indexOf(t);
          const buktiBtn = t.buktiDataUrl ? `<button class="btn btn-sm btn-outline-primary" onclick="lihatBukti(${idx})">Lihat</button>` : '-';
          transaksiList.innerHTML += `
            <tr>
              <td>${t.tanggal}</td>
              <td>${t.keterangan}</td>
              <td>${t.jenis}</td>
              <td>${formatRupiah(t.nominal)}</td>
              <td><span class="badge rounded-pill text-bg-info badge-kategori">${t.kategori||'-'}</span></td>
              <td>${buktiBtn}</td>
              <td>
                <button class="btn btn-sm btn-danger" onclick="hapusTransaksi(${idx})">Hapus</button>
              </td>
            </tr>`;
        });
      }

      // Hitung total
      let pemasukan = filtered.filter(t=>t.jenis==="Pemasukan").reduce((a,b)=>a+b.nominal,0);
      let pengeluaran = filtered.filter(t=>t.jenis==="Pengeluaran").reduce((a,b)=>a+b.nominal,0);
      document.getElementById("totalPemasukan").innerText = formatRupiah(pemasukan);
      document.getElementById("totalPengeluaran").innerText = formatRupiah(pengeluaran);
      document.getElementById("saldo").innerText = formatRupiah(pemasukan-pengeluaran);

      // Persentase bayar
      document.getElementById("persentaseBayar").innerText =
        `Persentase bayar bulan ini: ${persenSudahBayar(bulanDipilih, tahunDipilih)}%`;

      // Info login
      document.getElementById("loginInfo").innerText = config.currentUser ? `Login sebagai: ${config.currentUser.role}` : 'Tidak login';
    }

    // === LOGIN SEDERHANA ===
    function login(){
      Swal.fire({
        title: "Login",
        html: `
          <select id="role" class="form-select mb-2">
            <option value="Ketua">Ketua</option>
            <option value="Bendahara">Bendahara</option>
          </select>
          <input type="password" id="pin" class="form-control" placeholder="PIN">
        `,
        showCancelButton: true,
        confirmButtonText: "Masuk"
      }).then(res=>{
        if (!res.isConfirmed) return;
        const role = document.getElementById("role").value;
        const pin = document.getElementById("pin").value;
        if (config.roles[role] && config.roles[role]===pin){
          config.currentUser = {role};
          simpanData();
          Swal.fire("Berhasil","Login sebagai "+role,"success");
          render();
        } else {
          Swal.fire("Gagal","PIN salah","error");
        }
      });
    }

    // === ANGGOTA ===
    function tambahAnggota() {
      Swal.fire({
        title: "Tambah Anggota",
        html: `
          <input id="nama" class="form-control mb-2" placeholder="Nama Anggota">
          <input id="alamat" class="form-control mb-2" placeholder="Alamat">
          <input id="hp" class="form-control mb-2" placeholder="Nomor HP (628xxxxxxxxxx)">
          <input id="jabatan" class="form-control mb-2" placeholder="Jabatan di Karang Taruna">
          <div class="form-check text-start">
            <input class="form-check-input" type="checkbox" id="aktif" checked>
            <label class="form-check-label" for="aktif">Aktif</label>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: "Simpan"
      }).then(res=>{
        if(res.isConfirmed){
          const nama = (document.getElementById("nama").value||"").trim();
          if(!nama) return Swal.fire("Oops","Nama harus diisi","warning");
          const alamat = document.getElementById("alamat").value||"";
          const hp = document.getElementById("hp").value||"";
          const jabatan = document.getElementById("jabatan").value||"";
          const aktif = document.getElementById("aktif").checked;
          anggota.push({nama, alamat, hp, jabatan, aktif});
          simpanData(); render();
          Swal.fire("Berhasil!","Anggota ditambahkan","success");
        }
      });
    }

    function editAnggota(i){
      const a = anggota[i];
      Swal.fire({
        title:"Edit Anggota",
        html: `
          <input id="nama" class="form-control mb-2" placeholder="Nama" value="${a.nama||''}">
          <input id="alamat" class="form-control mb-2" placeholder="Alamat" value="${a.alamat||''}">
          <input id="hp" class="form-control mb-2" placeholder="Nomor HP (628...)" value="${a.hp||''}">
          <input id="jabatan" class="form-control mb-2" placeholder="Jabatan" value="${a.jabatan||''}">
          <div class="form-check text-start">
            <input class="form-check-input" type="checkbox" id="aktif" ${a.aktif!==false?'checked':''}>
            <label class="form-check-label" for="aktif">Aktif</label>
          </div>
        `,
        showCancelButton:true,
        confirmButtonText:"Simpan"
      }).then(res=>{
        if(res.isConfirmed){
          a.nama = (document.getElementById("nama").value||"").trim();
          a.alamat = document.getElementById("alamat").value||"";
          a.hp = document.getElementById("hp").value||"";
          a.jabatan = document.getElementById("jabatan").value||"";
          a.aktif = document.getElementById("aktif").checked;
          simpanData(); render();
          Swal.fire("Berhasil!","Data anggota diperbarui","success");
        }
      });
    }

    function hapusAnggota(i){
      Swal.fire({
        title:"Hapus anggota?",
        icon:"warning",
        showCancelButton:true,
        confirmButtonText:"Ya, hapus"
      }).then(res=>{
        if(res.isConfirmed){
          anggota.splice(i,1);
          simpanData(); render();
          Swal.fire("Terhapus!","Anggota berhasil dihapus","success");
        }
      });
    }

    // Tandai lunas => otomatis buat pemasukan defaultIuran
    function tandaiLunas(i){
      if(!cekBulanAktif()) return Swal.fire("Oops","Hanya bisa input di bulan & tahun berjalan","warning");
      const a = anggota[i];
      const tahunDipilih = parseInt(document.getElementById("tahunSelect").value);
      const bulanDipilih = parseInt(document.getElementById("bulanSelect").value);
      // cek sudah ada iuran?
      const sudah = transaksi.some(t=>t.jenis==="Pemasukan" && t.nama===a.nama && t.bulan==bulanDipilih && t.tahun==tahunDipilih);
      if (sudah) return Swal.fire("Info","Anggota ini sudah bayar bulan ini","info");
      const n = config.defaultIuran || 10000;
      const now = new Date();
      transaksi.push({
        tanggal: now.toLocaleDateString(),
        nama: a.nama,
        keterangan: "Iuran " + a.nama,
        jenis: "Pemasukan",
        nominal: n,
        bulan: bulanDipilih,
        tahun: tahunDipilih,
        kategori: "Iuran"
      });
      simpanData(); render();
      Swal.fire("Berhasil!","Ditandai lunas & iuran dicatat","success");
    }

    // === TRANSAKSI ===
    function tambahIuran() {
      if(!cekBulanAktif()) return Swal.fire("Oops","Hanya bisa input di bulan & tahun berjalan","warning");
      if(anggota.length===0) return Swal.fire("Oops","Belum ada anggota","warning");
      Swal.fire({
        title: "Tambah Iuran",
        html: `
          <select id="anggotaSelect" class="form-select mb-2">
            ${anggota.map((a,i)=>`<option value="${i}">${a.nama}</option>`).join("")}
          </select>
          <input type="number" id="nominal" class="form-control mb-2" placeholder="Nominal (kosong=default ${config.defaultIuran})">
        `,
        showCancelButton:true,
        confirmButtonText:"Simpan"
      }).then(res=>{
        if(res.isConfirmed){
          let i = parseInt(document.getElementById("anggotaSelect").value);
          let n = parseInt(document.getElementById("nominal").value||config.defaultIuran||0);
          if(n>0){
            let now = new Date();
            transaksi.push({
              tanggal: now.toLocaleDateString(),
              nama: anggota[i].nama,
              keterangan:"Iuran "+anggota[i].nama,
              jenis:"Pemasukan",
              nominal:n,
              bulan: now.getMonth()+1,
              tahun: now.getFullYear(),
              kategori: "Iuran"
            });
            simpanData(); render();
            Swal.fire("Berhasil!","Iuran ditambahkan","success");
          }
        }
      });
    }

    function tambahPengeluaran() {
      if(!cekBulanAktif()) return Swal.fire("Oops","Hanya bisa input di bulan & tahun berjalan","warning");
      Swal.fire({
        title:"Tambah Pengeluaran",
        html: `
          <input id="ket" class="form-control mb-2" placeholder="Keterangan">
          <input id="nom" type="number" class="form-control mb-2" placeholder="Nominal">
          <select id="kat" class="form-select mb-2">
            <option value="Kegiatan">Kegiatan</option>
            <option value="Perlengkapan">Perlengkapan</option>
            <option value="Donasi">Donasi</option>
            <option value="Lainnya">Lainnya</option>
          </select>
          <div class="text-start mb-2">
            <label class="form-label">Bukti (opsional)</label>
            <input id="bukti" type="file" class="form-control" accept="image/*">
          </div>
        `,
        showCancelButton:true,
        confirmButtonText:"Simpan",
        didOpen: ()=>{
          const input = document.getElementById('bukti');
          input && (input.value = "");
        }
      }).then(async res=>{
        if(res.isConfirmed){
          let k=document.getElementById("ket").value;
          let n=parseInt(document.getElementById("nom").value||0);
          let kat=document.getElementById("kat").value;
          let buktiInput=document.getElementById("bukti");
          let dataUrl=null;
          if(buktiInput && buktiInput.files && buktiInput.files[0]){
            dataUrl = await fileToDataURL(buktiInput.files[0]);
          }
          if(n>0){
            let now = new Date();
            transaksi.push({
              tanggal: now.toLocaleDateString(),
              keterangan: k || "Pengeluaran",
              jenis:"Pengeluaran",
              nominal:n,
              bulan: now.getMonth()+1,
              tahun: now.getFullYear(),
              kategori: kat,
              buktiDataUrl: dataUrl
            });
            simpanData(); render();
            Swal.fire("Berhasil!","Pengeluaran ditambahkan","success");
          }
        }
      });
    }

    function fileToDataURL(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = err => reject(err);
        reader.readAsDataURL(file);
      });
    }

    function lihatBukti(i){
      const t = transaksi[i];
      if(!t || !t.buktiDataUrl) return;
      Swal.fire({
        title: "Bukti Transaksi",
        imageUrl: t.buktiDataUrl,
        imageAlt: "Bukti",
        width: 600
      });
    }

    function hapusTransaksi(i){
      Swal.fire({
        title:"Hapus transaksi?",
        icon:"warning",
        showCancelButton:true,
        confirmButtonText:"Ya, hapus"
      }).then(res=>{
        if(res.isConfirmed){
          transaksi.splice(i,1);
          simpanData(); render();
          Swal.fire("Terhapus!","Transaksi berhasil dihapus","success");
        }
      });
    }

    // === EXPORT / LAPORAN ===
    function exportExcel() {
        let data =
            "Nama\tIuran\nBudi\t10000\nSiti\t0";
        let blob = new Blob([data], { type: "application/vnd.ms-excel" });
        let url = URL.createObjectURL(blob);

        let a = document.createElement("a");
        a.href = url;
        a.download = "laporan.xlsx";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    
    function unduhPDF(){
      let tahunDipilih = parseInt(document.getElementById("tahunSelect").value);
      let bulanDipilih = parseInt(document.getElementById("bulanSelect").value);
      const bulanNama = ["Januari","Februari","Maret","April","Mei","Juni","Juli",
                         "Agustus","September","Oktober","November","Desember"];
      let doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("Laporan Keuangan Karang Taruna Kuti Berseri", 14, 20);
      doc.text("Periode: "+bulanNama[bulanDipilih-1]+" "+tahunDipilih, 14, 28);

      let filtered = transaksi.filter(t=>t.bulan==bulanDipilih && t.tahun==tahunDipilih);
      let y = 40;
      doc.setFontSize(12);
      if(filtered.length===0){
        doc.text("Belum ada transaksi", 14, y);
        y+=8;
      } else {
        filtered.forEach(t=>{
          doc.text(`${t.tanggal} | ${t.keterangan} | ${t.jenis} | ${t.kategori||'-'} | ${formatRupiah(t.nominal)}`, 14, y);
          y+=8;
          if (y>280){ doc.addPage(); y=20; }
        });
      }
      let pemasukan = filtered.filter(t=>t.jenis==="Pemasukan").reduce((a,b)=>a+b.nominal,0);
      let pengeluaran = filtered.filter(t=>t.jenis==="Pengeluaran").reduce((a,b)=>a+b.nominal,0);
      y+=10;
      doc.text("Total Pemasukan: "+formatRupiah(pemasukan),14,y); y+=8;
      doc.text("Total Pengeluaran: "+formatRupiah(pengeluaran),14,y); y+=8;
      doc.text("Saldo: "+formatRupiah(pemasukan-pengeluaran),14,y);

      doc.save(`Laporan_${bulanNama[bulanDipilih-1]}_${tahunDipilih}.pdf`);
    }

    function exportCSV(filename, rows){
      const process = rows.map(r => r.map(c => {
        let s = (c===null || c===undefined) ? '' : String(c);
        if (s.includes('"') || s.includes(',') || s.includes('\n')) {
          s = '"' + s.replace(/"/g,'""') + '"';
        }
        return s;
      }).join(",")).join("\n");
      const blob = new Blob([process], {type: "text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportTransaksiExcel(){
      let tahunDipilih = parseInt(document.getElementById("tahunSelect").value);
      let bulanDipilih = parseInt(document.getElementById("bulanSelect").value);
      let kategoriDipilih = document.getElementById("kategoriFilter").value;
      let filtered = transaksi.filter(t=>t.bulan==bulanDipilih && t.tahun==tahunDipilih);
      if (kategoriDipilih) filtered = filtered.filter(t => (t.kategori||"") === kategoriDipilih || (kategoriDipilih==="Iuran" && t.kategori==="Iuran"));
      const rows = [["Tanggal","Keterangan","Jenis","Nominal","Kategori","Nama Anggota"]];
      filtered.forEach(t=>{
        rows.push([t.tanggal, t.keterangan, t.jenis, t.nominal, t.kategori||"", t.nama||""]);
      });
      exportCSV(`Transaksi_${bulanDipilih}-${tahunDipilih}.csv`, rows);
    }

    function exportTahunanExcel(){
      const tahun = parseInt(document.getElementById("tahunSelect").value);
      const rows = [["Bulan","Pemasukan","Pengeluaran","Saldo"]];
      for(let b=1;b<=12;b++){
        const data = transaksi.filter(t=>t.tahun==tahun && t.bulan==b);
        const inSum = data.filter(t=>t.jenis==="Pemasukan").reduce((a,b)=>a+b.nominal,0);
        const outSum = data.filter(t=>t.jenis==="Pengeluaran").reduce((a,b)=>a+b.nominal,0);
        rows.push([b, inSum, outSum, inSum-outSum]);
      }
      exportCSV(`Rekap_Tahunan_${tahun}.csv`, rows);
    }

    function exportAnggotaExcel(){
      const rows = [["Nama","Alamat","HP","Jabatan","Aktif"]];
      anggota.forEach(a=> rows.push([a.nama, a.alamat||"", a.hp||"", a.jabatan||"", (a.aktif!==false)?"Ya":"Tidak"]));
      exportCSV("Daftar_Anggota.csv", rows);
    }

    function exportAnggotaPDF(){
      let doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("Daftar Anggota Karang Taruna Kuti Berseri", 14, 20);
      doc.setFontSize(12);
      let y=30;
      if(anggota.length===0){
        doc.text("Belum ada data anggota", 14, y);
      } else {
        anggota.forEach((a,idx)=>{
          const line = `${idx+1}. ${a.nama} | ${a.jabatan||'-'} | ${a.hp||'-'} | ${a.alamat||'-'} | Aktif: ${(a.aktif!==false)?"Ya":"Tidak"}`;
          doc.text(line, 14, y);
          y+=8;
          if (y>280){ doc.addPage(); y=20; }
        });
      }
      doc.save("Daftar_Anggota.pdf");
    }

    // === REMINDER / WHATSAPP ===
    function encodeWA(text){ return encodeURIComponent(text); }
    function openWA(number, text){
      const link = `https://wa.me/${number}?text=${encodeURIComponent(text)}`;
      window.open(link, "_blank");
    }

    function kirimWAIndividu(i){
      const a = anggota[i];
      if(!a.hp) return Swal.fire("Oops","Nomor HP belum diisi","warning");
      let tahunDipilih = parseInt(document.getElementById("tahunSelect").value);
      let bulanDipilih = parseInt(document.getElementById("bulanSelect").value);
      const bulanNama = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
      const pesan = `Halo ${a.nama}, pengingat iuran Karang Taruna periode ${bulanNama[bulanDipilih-1]} ${tahunDipilih}. Terima kasih. üôè`;
      openWA(a.hp, pesan);
    }

    function ingatkanBelumBayar(){
      if(anggota.length===0) return Swal.fire("Info","Belum ada anggota","info");
      let tahunDipilih = parseInt(document.getElementById("tahunSelect").value);
      let bulanDipilih = parseInt(document.getElementById("bulanSelect").value);
      const bulanNama = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
      const belum = anggota.filter(a=>{
        const iuran = transaksi.filter(t=>t.jenis==="Pemasukan" && t.nama==a.nama && t.bulan==bulanDipilih && t.tahun==tahunDipilih)
                      .reduce((s,t)=>s+t.nominal,0);
        return (a.aktif!==false) && iuran===0;
      });
      if (belum.length===0) return Swal.fire("Mantap!","Semua anggota sudah bayar bulan ini","success");
      belum.forEach(a=>{
        if(a.hp){
          const pesan = `Halo ${a.nama}, pengingat iuran Karang Taruna periode ${bulanNama[bulanDipilih-1]} ${tahunDipilih}. Nominal: Rp ${config.defaultIuran}. Terima kasih. üôè`;
          openWA(a.hp, pesan);
        }
      });
      // Notif admin ringkas
      kirimNotifikasiAdmin(`Reminder dikirim ke ${belum.length} anggota yang belum bayar iuran periode ${bulanNama[bulanDipilih-1]} ${tahunDipilih}.`);
    }

    // Notifikasi ke admin tetap (dua nomor)
    function kirimNotifikasiAdmin(pesan){
      (config.adminNumbers||[]).forEach(no=> openWA(no, pesan));
    }

    // === INIT / MIGRATE OLD DATA ===
    function initialSeed(){
      anggota = (anggota||[]).map(a=>{
        if (a.aktif===undefined) a.aktif = true;
        return a;
      });
      simpanData();
    }

    isiDropdown();
    initialSeed();
    render();

  </script>
</body>

</html>
